import os
import yt_dlp
import asyncio
from telegram import Update
from telegram.ext import Application, MessageHandler, filters, ContextTypes, CommandHandler

# Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù„Ø¹Ø§Ù… 2026.\n\nØ£Ø±Ø³Ù„ Ù„ÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (TikTok, YouTube, Insta) ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡ Ù„Ùƒ ÙÙˆØ±Ø§Ù‹.")

# Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
async def handle_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = update.message.text
    if not url.startswith("http"):
        return

    chat_id = update.message.chat_id
    msg = await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·... Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹")

    try:
        file_path = f"{chat_id}_vid.mp4"
        ydl_opts = {
            'format': 'best',
            'outtmpl': file_path,
            'quiet': True,
        }
        
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            await asyncio.to_thread(ydl.download, [url])

        with open(file_path, 'rb') as video:
            await update.message.reply_video(video=video, caption="âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
        
        os.remove(file_path)
        await msg.delete()
    except Exception as e:
        await msg.edit_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

def main():
    token = os.environ.get("BOT_TOKEN")
    app = Application.builder().token(token).build()
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_video))
    
    print("Bot is running...")
    app.run_polling()

if __name__ == '__main__':
    main()
